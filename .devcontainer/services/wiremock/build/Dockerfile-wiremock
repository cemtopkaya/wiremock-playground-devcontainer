# wiremock/wiremock:3.13.1 yerine en baştan başlıyoruz:
FROM eclipse-temurin:11-jre AS base

# --- Wiremock Ayarları ------------------------------------------------------
ENV WIREMOCK_DIRECTORY=/home/wiremock
ENV WIREMOCK_VERSION=3.13.1
ENV WIREMOCK_PORT=8080


RUN apt-get update && \
    apt-get install -y ca-certificates gnupg git wget curl nano jq yq xq

# WireMock jar'ını indir
RUN set -eux; \
    mkdir -p /var/wiremock/lib; \
    mkdir -p /var/wiremock/extensions; \
    wget -q https://repo1.maven.org/maven2/org/wiremock/wiremock-standalone/${WIREMOCK_VERSION}/wiremock-standalone-${WIREMOCK_VERSION}.jar -O /var/wiremock/lib/wiremock.jar

# WireMock eklentilerini indir
RUN set -eux; \
    cd /var/wiremock/extensions; \
    wget -q https://repo1.maven.org/maven2/com/opentable/wiremock-body-transformer/1.1.3/wiremock-body-transformer-1.1.3.jar && \
    wget -q https://repo1.maven.org/maven2/org/wiremock/wiremock-webhooks-extension/3.0.4/wiremock-webhooks-extension-3.0.4.jar && \
    wget -q https://repo1.maven.org/maven2/org/wiremock/wiremock-grpc-extension-standalone/0.9.0/wiremock-grpc-extension-standalone-0.9.0.jar && \
    mkdir -p /home/wiremock/grpc && \
    wget -q https://repo1.maven.org/maven2/org/wiremock/extensions/wiremock-state-extension-standalone/0.9.3/wiremock-state-extension-standalone-0.9.3.jar && \
    wget -q https://repo1.maven.org/maven2/org/wiremock/extensions/wiremock-jwt-extension-standalone/0.3.0/wiremock-jwt-extension-standalone-0.3.0.jar && \
    wget -q https://repo1.maven.org/maven2/org/wiremock/extensions/wiremock-faker-extension-standalone/0.2.0/wiremock-faker-extension-standalone-0.2.0.jar

EXPOSE 8080 8443

# docker-entrypoint.sh dosyasını kopyala ve çalıştırılabilir yap
COPY ./docker-entrypoint.sh /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh

# Healthcheck ekle
HEALTHCHECK --interval=5s --start-period=5s --timeout=3s --retries=3 \
    CMD curl -f http://localhost:$WIREMOCK_PORT/__admin/health || exit 1


# Zsh kur
RUN apt-get install -y zsh && \
    # Oh My Zsh yükle (non-interactive)
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended && \
    # Varsayılan shell olarak zsh ayarla
    chsh -s $(which zsh) && \
    # root Kullanıcısının varsayılan shell olarak zsh ayarla
    chsh -s /usr/bin/zsh root && \
    # Zsh config dosyasını özelleştir (örnek: agnoster teması)
    sed -i 's/ZSH_THEME=".*"/ZSH_THEME="agnoster"/' ~/.zshrc


RUN mkdir -p /etc/apt/keyrings \
    && curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian bookworm stable" > /etc/apt/sources.list.d/docker.list \
    && apt-get update \
    && apt-get install -y docker-ce-cli

# --- Docker CLI Ayarları ----------------------------------------------------
# Docker CLI ve bash/zsh completion yükle
# Zsh için completion yükle
RUN mkdir -p /usr/share/zsh/vendor-completions && \
    docker completion zsh > /usr/share/zsh/vendor-completions/_docker && \
    echo "source /usr/share/zsh/vendor-completions/_docker" >> /etc/zsh/zshrc

# Bash için Docker CLI için auto completion
RUN mkdir -p /etc/bash_completion.d \
    && docker completion bash > /etc/bash_completion.d/docker.sh \
    && echo "source /etc/bash_completion.d/docker.sh" >> /etc/bash.bashrc


# --- wiremock KULLANICISI OLUŞTURMAK -----------------------------------------
# `USER wiremock` koymak ve home directory oluşturmak şunları sağlıyor:
# `/home/wiremock` artık gerçekten var, chown sorunsuz çalışır.
# Container içindeki default işlemci artık root değil wiremock kullanıcısı oluyor.
# Yani güvenlik açısından daha iyi.
# Eğer yine uid parametresi verilirse, `docker-entrypoint.sh` onu `gosu` ile kullanır; verilmezse zaten wiremock kullanıcısı ile çalışır.
# Yani kısaca: `USER wiremock` koymak, `docker-entrypoint.sh`’ın UID mantığını güvenli ve anlamlı hâle getiriyor.
# Yoksa uid parametresi verilse bile, home directory ve ownership olmadığı için hata alırsın.
#
# WireMock grubu ve kullanıcısı yoksa oluştur
RUN groupadd -r wiremock
RUN useradd -m -d /home/wiremock -s /usr/bin/zsh -g wiremock wiremock
# RUN usermod -aG docker wiremock

# WireMock home directory izinlerini ayarla
RUN chown -R wiremock:wiremock /home/wiremock /var/wiremock

WORKDIR /var/wiremock

# WireMock başlat (docker-entrypoint.sh üzerinden)
ENTRYPOINT ["/docker-entrypoint.sh"]


# CMD [
#     '--global-response-templating',
#     '--disable-gzip',
#     '--verbose',
#     '--port',
#     '${WIREMOCK_PORT}',
#     '--root-dir',
#     '/home/wiremock',
#     '--proxy-all=http://devcontainer:8080',
#     '--extensions',
#     'org.wiremock.webhooks.Webhooks',
#     'com.github.tomakehurst.wiremock.extension.responsetemplating.ResponseTemplateTransformer'
# ]
