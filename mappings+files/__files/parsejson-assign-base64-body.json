{{#parseJson 'data'}}
{
  "sub": {
    "cmpfToken": {
      "hash": "6bfa249f",
      "token": "95ce31a5",
      "uid": 311,
      "oid": 282
    },
    "username": "user@company.com"
  },
  "resourceName": "Portal Project",
  "jti": "9c52d2d2-a6c2-4e71-bb5d-05bb7c287206",
  "iat": 1756794036,
  "exp": 1756797636
}
{{/parseJson}}

{{#assign 'tokenLiteral'}}
{
  "sub": {{{jsonPath data '$.sub'}}},
  "jti": "{{{jsonPath tokenClaim '$.jti'}}}",
  "resourceName": "{{{jsonPath data '$.resourceName'}}}",
  "iat": {{now timezone='Europe/Istanbul' format='epoch'}},
  "exp": {{now timezone='Europe/Istanbul' offset='now +1 hours' format='epoch'}}
}
{{/assign}}


{{!-- AÇIKLAMA:
- ISO 8601, insan ve makineler için en yaygın ve anlaşılır, standart tarih ve zaman gösterimidir.
- Unix(saniye)/Epoch(milisaniye) zamanı, 1970-01-01 00:00:00 UTC referans alınarak geçen süreyi ifade eden bir formattır.
- Unix Zamanı (Unix timestamp), 1 Ocak 1970 00:00:00 UTC'den itibaren geçen saniye sayısıdır.
- Epoch Zamanı, genellikle Unix zamanı ile eş anlamlı olarak kullanılır; fakat bazen milisaniye (1/1000) cinsinden sayıyı ifade edebilir.
- Epoch (milisaniye): date.getTime()
- Unix (saniye): Math.floor(date.getTime() / 1000)
--}}
{{#assign 'refreshTokenLiteral'}}
{
  "sub": {{{jsonPath data '$.sub'}}},
  "jti": "{{{jsonPath tokenClaim '$.jti'}}}",
  "resourceName": "{{{jsonPath data '$.resourceName'}}}",
  "iat": {{now timezone='Europe/Istanbul' format='unix'}},
  "exp": {{now timezone='Europe/Istanbul' offset='now +1 hours' format='unix'}},
  "nbf": {{now timezone='Europe/Istanbul' offset='now +50 minutes' format='unix'}},
  "refreshOnly": true
}
{{/assign}}

{{!-- AÇIKLAMA:
Sabit bir değer olacak ve {"alg": "HS256","typ": "JWT"} değerinin base64 kodlu hali olacak
--}}
{{#assign 'header'}}
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.
{{/assign}}

{{!-- AÇIKLAMA:
İmzaymış gibi sabit bir değer verilebilir : .KMUFsIDTnFmyG3nMiGM6H9FNFUROf3wh7SmqJp-QV30
veya dinamik değer üretilebilir           : .{{randomValue type='ALPHANUMERIC' length=43}}
--}}
{{#assign 'signature'}}
.{{randomValue type='ALPHANUMERIC' length=43}}
{{/assign}}

{{#assign 'tokenPayload'}}
{{base64 tokenLiteral}}
{{/assign}}

{{#assign 'refreshTokenPayload'}}
{{base64 refreshTokenLiteral}}
{{/assign}}

{{!-- AÇIKLAMA:
Base64 ve Base64Url aynı temel encoding şemasıdır ama Base64Url, Base64'ün URL ve dosya isimlerinde kullanılmaya uygun hale getirilmiş bir varyantıdır. Aralarındaki farklar şunlardır:
- Base64'te kullanılan '+' ve '/' karakterleri Base64Url'de '-' ve '_' ile değiştirilir.
- Base64'te padding için '=' karakteri kullanılırken, Base64Url'de padding genellikle kaldırılır (opsiyoneldir).
- Böylece Base64Url çıktısı URL içinde güvenle kullanılabilir, Base64 ise URL'de kullanıldığında ekstra encode gerekebilir.
--}}


{{#assign 'tokenPayload'}}{{replace tokenPayload "=" ""}}{{/assign}}
{{#assign 'tokenPayload'}}{{replace tokenPayload "+" "-"}}{{/assign}}
{{#assign 'tokenPayload'}}{{replace tokenPayload "/" "_"}}{{/assign}}

{{#assign 'refreshTokenPayload'}}{{replace refreshTokenPayload "=" ""}}{{/assign}}
{{#assign 'refreshTokenPayload'}}{{replace refreshTokenPayload "+" "-"}}{{/assign}}
{{#assign 'refreshTokenPayload'}}{{replace refreshTokenPayload "/" "_"}}{{/assign}}

{
  "token": "{{header}}{{tokenPayload}}{{signature}}",
  "refreshToken": "{{header}}{{refreshTokenPayload}}{{signature}}"
}
